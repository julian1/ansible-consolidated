

- hosts:
    # Use static ip, since if dns goes wrong, we can end up provisioning 127.0.0.1
    - 192.168.100.1
    # - 172.16.0.1
  vars_files:
    - "{{inventory_dir | dirname}}/credentials.yml"

  vars:
    kernel: 4.9.0-5
    uuid: 89c7d75c-67eb-41f4-83cb-e1fa8890e8d5

  pre_tasks:

    # - apt: name=extlinux
    # ~$ ls /boot/syslinux/
    # ldlinux.c32  ldlinux.sys  syslinux.cfg
    # for kernel upgrade version - must manually update syslinux.cfg with new boot label
    # syslinux is conventional, except net.ifnames to prevent nic renaming, and serial speed.
    - copy:
        dest: /boot/syslinux/syslinux.cfg
        content: |
          # deployed by ansible!

          CONSOLE 0
          SERIAL 0 115200 0
          DEFAULT linux-{{kernel}}
          PROMPT 0
          LABEL linux-{{kernel}}
            SAY Now booting the kernel from SYSLINUX...
            KERNEL /boot/vmlinuz-{{kernel}}-amd64
            APPEND rw root=UUID={{uuid}} initrd=/boot/initrd.img-{{kernel}}-amd64 vga=normal fb=false console=ttyS0,115200n8 net.ifnames=0 biosdevname=0

          LABEL linux-4.9.0-3
            SAY Now booting the kernel from SYSLINUX...
            KERNEL /boot/vmlinuz-4.9.0-3-amd64
            APPEND rw root=UUID=89c7d75c-67eb-41f4-83cb-e1fa8890e8d5 initrd=/boot/initrd.img-4.9.0-3-amd64 vga=normal fb=false console=ttyS0,115200n8 net.ifnames=0 biosdevname=0

    # root user
    - user: name=root shell=/bin/bash
    - authorized_key: user=root key="{{meteo_pubkey}}"

    # meteo unprivileged user
    - user: name=meteo shell=/bin/bash password={{meteo_password}} groups=sudo
    - file: path=/home/meteo mode=0700 owner=meteo group=meteo state=directory

    - authorized_key: user=meteo key="{{meteo_pubkey}}"


  roles:
    - name: admin/stretch
      mirror: http://ftp.au.debian.org/debian/

    - name: admin/sshd
      listen_address: 192.168.100.1 

    - name: admin/sensors
      
    - admin/timezone
    - admin/locale
    - admin/ip-forwarding

    - name: admin/hostname
      hostname: apu

    # the main node-specific role
    - admin/apu

  tasks:
  handlers:

